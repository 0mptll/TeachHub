@model EnrollmentViewModel

@{
    ViewData["Title"] = "Enroll in Course";
}

<h1>Enroll in @ViewBag.Course.Title</h1>

<h4>Course Details</h4>
<hr />
<div>
    <p><strong>Title:</strong> @ViewBag.Course.Title</p>
    <p><strong>Description:</strong> @ViewBag.Course.Description</p>
    <p><strong>Price:</strong> $@ViewBag.Course.Price</p>
</div>

<div class="row">
    <div class="col-md-4">
        <form asp-action="Enroll" method="post" id="enrollment-form">
            <input type="hidden" asp-for="CourseId" value="@ViewBag.Course.CourseId" />
            <input type="hidden" asp-for="LearnerId" value="@ViewData["LearnerId"]" />

            <!-- Payment fields -->
            <h4>Payment Details</h4>
            <p>You need to pay: $@ViewBag.Course.Price</p>
            <div id="card-element"><!-- A Stripe Element will be inserted here. --></div>

            <input type="hidden" id="stripeToken" name="stripeToken" />

            <button type="submit" class="btn btn-primary">Pay and Enroll Now</button>

            <div id="payment-response" style="color: red;">
                @if (!string.IsNullOrEmpty(ViewBag.PaymentError))
                {
                    <p>@ViewBag.PaymentError</p>
                }
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('@ViewBag.StripePublishableKey');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        const paymentForm = document.getElementById('enrollment-form');
        paymentForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Stop form temporarily to fetch token

            // Create a token and set its value in the hidden input field
            const { token, error } = await stripe.createToken(cardElement);
            if (error) {
                document.getElementById('payment-response').innerText = error.message;
            } else {
                // Set the Stripe token in the hidden field
                document.getElementById('stripeToken').value = token.id;

                // Now allow the form to submit with Stripe token
                paymentForm.submit();
            }
        });
    </script>
}
